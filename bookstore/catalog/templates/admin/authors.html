{% extends 'admin/base.html' %}

{% block page_title %}Управление авторами{% endblock %}

{% block page_actions %}
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAuthorModal">
    <i class="fas fa-plus"></i> Добавить автора
</button>
{% endblock %}

{% block content %}
<!-- Таблица авторов -->
<div class="card admin-table">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Фамилия</th>
                        <th>Имя</th>
                        <th>Дата рождения</th>
                        <th>Количество книг</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for author in authors %}
                    <tr>
                        <td>{{ author.last_name }}</td>
                        <td>{{ author.first_name }}</td>
                        <td>{{ author.birth_date|date:"d.m.Y"|default:"Не указана" }}</td>
                        <td>
                            <span class="badge bg-primary">{{ author.book_count }}</span>
                        </td>
                        <td>
                            <a href="#" class="btn btn-sm btn-outline-primary" 
                               data-bs-toggle="modal" 
                               data-bs-target="#editAuthorModal"
                               data-author-id="{{ author.id }}"
                               data-author-first-name="{{ author.first_name }}"
                               data-author-last-name="{{ author.last_name }}"
                               data-author-birth-date="{{ author.birth_date|date:'Y-m-d' }}"
                               data-author-website="{{ author.website|default:'' }}"
                               data-author-bio="{{ author.bio|default:'' }}">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'admin_author_delete' author.id %}" class="btn btn-sm btn-outline-danger">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4">Авторы не найдены</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Модальное окно добавления автора -->
<div class="modal fade" id="addAuthorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить автора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'admin_authors' %}" class="admin-form" id="addAuthorForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Имя *</label>
                                <input type="text" name="first_name" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Фамилия *</label>
                                <input type="text" name="last_name" class="form-control" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Дата рождения</label>
                                <input type="date" name="birth_date" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Веб-сайт</label>
                                <input type="url" name="website" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Биография</label>
                        <textarea name="bio" class="form-control" rows="4"></textarea>
                    </div>

                    <div class="d-flex gap-2 pt-3 border-top">
                        <button type="submit" class="btn btn-primary" name="add_author">
                            <i class="fas fa-plus-circle me-2"></i>Добавить автора
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Единое модальное окно редактирования автора -->
<div class="modal fade" id="editAuthorModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать автора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'admin_authors' %}" class="admin-form" id="editAuthorForm">
                    {% csrf_token %}
                    <input type="hidden" name="author_id" id="editAuthorId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Имя *</label>
                                <input type="text" name="first_name" class="form-control" id="editAuthorFirstName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Фамилия *</label>
                                <input type="text" name="last_name" class="form-control" id="editAuthorLastName" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Дата рождения</label>
                                <input type="date" name="birth_date" class="form-control" id="editAuthorBirthDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Веб-сайт</label>
                                <input type="url" name="website" class="form-control" id="editAuthorWebsite">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Биография</label>
                        <textarea name="bio" class="form-control" rows="4" id="editAuthorBio"></textarea>
                    </div>

                    <div class="d-flex gap-2 pt-3 border-top">
                        <button type="submit" class="btn btn-primary" name="edit_author">
                            <i class="fas fa-save me-2"></i>Сохранить изменения
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .admin-form .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    
    .admin-form .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        border: none;
        padding: 20px 25px;
    }
    
    .admin-form .modal-title {
        font-weight: 600;
        font-size: 1.25rem;
    }
    
    .admin-form .modal-body {
        padding: 25px;
    }
    
    .admin-form .btn-close {
        filter: invert(1);
        opacity: 0.8;
    }
    
    .admin-form .btn-close:hover {
        opacity: 1;
    }
    
    .admin-form .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .admin-form .form-control {
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        padding: 0.75rem;
        transition: all 0.2s ease;
    }
    
    .admin-form .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    
    .admin-form textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }
    
    .admin-form .border-top {
        border-color: #e2e8f0 !important;
        padding-top: 20px;
    }
    
    .admin-form .btn {
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .admin-form .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    
    .admin-form .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .admin-form .btn-secondary {
        background-color: #6c757d;
        border: none;
    }
    
    .admin-form .btn-secondary:hover {
        background-color: #5a6268;
        transform: translateY(-1px);
    }
    
    /* Анимация модального окна */
    .modal.fade .modal-dialog {
        transform: translateY(-50px);
        transition: transform 0.3s ease-out;
    }
    
    .modal.show .modal-dialog {
        transform: translateY(0);
    }
    
    .btn {
        border-radius: 6px;
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
</style>

<script>
// Функция для сброса формы добавления
function resetAddForm() {
    const form = document.getElementById('addAuthorForm');
    if (form) {
        form.reset();
    }
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Сброс формы добавления при закрытии модального окна
    const addModal = document.getElementById('addAuthorModal');
    if (addModal) {
        addModal.addEventListener('hidden.bs.modal', function() {
            resetAddForm();
        });
    }

    // Обработка открытия модального окна редактирования
    const editButtons = document.querySelectorAll('[data-bs-target="#editAuthorModal"]');
    editButtons.forEach(function(button) {
        button.addEventListener('click', function() {
            // Получаем данные из data-атрибутов кнопки
            const authorId = this.getAttribute('data-author-id');
            const authorFirstName = this.getAttribute('data-author-first-name');
            const authorLastName = this.getAttribute('data-author-last-name');
            const authorBirthDate = this.getAttribute('data-author-birth-date');
            const authorWebsite = this.getAttribute('data-author-website');
            const authorBio = this.getAttribute('data-author-bio');
            
            // Заполняем форму редактирования актуальными данными
            document.getElementById('editAuthorId').value = authorId;
            document.getElementById('editAuthorFirstName').value = authorFirstName;
            document.getElementById('editAuthorLastName').value = authorLastName;
            document.getElementById('editAuthorBirthDate').value = authorBirthDate;
            document.getElementById('editAuthorWebsite').value = authorWebsite;
            document.getElementById('editAuthorBio').value = authorBio;
        });
    });

    // При закрытии модального окна редактирования ничего не делаем - 
    // при следующем открытии данные загрузятся заново из data-атрибутов
});

</script>
{% endblock %}